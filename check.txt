#!/bin/bash
set -e

echo "📥 Starting drift check..."

RESOURCE_TYPE="${RESOURCE_TYPE:-deployment}"
RESOURCE_NAME="${RESOURCE_NAME:-my-app}"
NAMESPACE="${NAMESPACE:-default}"
DESIRED_MANIFEST="${DESIRED_MANIFEST:-}"

if [[ -z "$DESIRED_MANIFEST" ]]; then
  echo "❌ Error: DESIRED_MANIFEST is not set"
  exit 0
fi

# Save desired manifest to file
echo "$DESIRED_MANIFEST" > /tmp/desired.yaml

# Fetch live manifest
kubectl get "$RESOURCE_TYPE" "$RESOURCE_NAME" -n "$NAMESPACE" -o yaml > /tmp/live-raw.yaml

# Clean live manifest by removing fields that cause drift
grep -vE '^\s*(creationTimestamp|resourceVersion|uid|generation|selfLink|status|managedFields|kubectl\.kubernetes\.io/last-applied-configuration):' /tmp/live-raw.yaml > /tmp/live-clean.yaml

echo "🔍 Performing diff check..."
diff_output=$(diff -u /tmp/desired.yaml /tmp/live-clean.yaml || true)

if [[ -n "$diff_output" ]]; then
  echo "🚨 Drift Detected:"
  echo "$diff_output"
else
  echo "✅ No drift detected."
fi

exit 0
