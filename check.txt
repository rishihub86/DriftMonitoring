#!/bin/bash
set -e

echo "📥 Fetching input..."

# Parameters passed via environment or args
RESOURCE_TYPE="${RESOURCE_TYPE:-deployment}"
RESOURCE_NAME="${RESOURCE_NAME:-my-app}"
NAMESPACE="${NAMESPACE:-default}"
DESIRED_MANIFEST="${DESIRED_MANIFEST:-}"

# Validation
if [[ -z "$DESIRED_MANIFEST" ]]; then
  echo "❌ Error: DESIRED_MANIFEST is empty"
  exit 1
fi

# Save the desired manifest
echo "✅ Writing desired manifest to /tmp/desired.yaml"
echo "$DESIRED_MANIFEST" > /tmp/desired.yaml

# Fetch the live resource from Kubernetes
echo "📡 Fetching live manifest from cluster"
kubectl get "$RESOURCE_TYPE" "$RESOURCE_NAME" -n "$NAMESPACE" -o yaml > /tmp/live.yaml

# Normalize both YAMLs
echo "🔄 Sorting YAML files for clean diff"
yq -P /tmp/desired.yaml > /tmp/desired_sorted.yaml
yq -P /tmp/live.yaml > /tmp/live_sorted.yaml

# Perform the diff
echo "🔍 Performing diff..."
diff_output=$(diff -u /tmp/desired_sorted.yaml /tmp/live_sorted.yaml || true)

if [[ -n "$diff_output" ]]; then
  echo "🚨 Drift Detected Between Desired and Live State:"
  echo "$diff_output"
  exit 2
else
  echo "✅ No drift detected."
fi
