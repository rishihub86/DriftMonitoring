#!/bin/bash
set -e

echo "📥 Starting drift check..."

RESOURCE_TYPE="${RESOURCE_TYPE:-deployment}"
RESOURCE_NAME="${RESOURCE_NAME:-my-app}"
NAMESPACE="${NAMESPACE:-default}"
DESIRED_MANIFEST="${DESIRED_MANIFEST:-}"

if [[ -z "$DESIRED_MANIFEST" ]]; then
  echo "❌ Error: DESIRED_MANIFEST is not set"
  exit 1
fi

echo "✅ Writing desired manifest to /tmp/desired.yaml"
echo "$DESIRED_MANIFEST" > /tmp/desired.yaml

echo "📡 Fetching live manifest from Kubernetes"
kubectl get "$RESOURCE_TYPE" "$RESOURCE_NAME" -n "$NAMESPACE" -o yaml > /tmp/live.yaml

echo "🔍 Performing raw diff check..."
diff_output=$(diff -u /tmp/desired.yaml /tmp/live.yaml || true)

if [[ -n "$diff_output" ]]; then
  echo "🚨 Drift Detected Between Desired and Live State:"
  echo "$diff_output"
  exit 2
else
  echo "✅ No drift detected."
fi
