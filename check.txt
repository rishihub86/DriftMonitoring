#!/bin/bash
set -e

# Parameters from environment variables
REPO_URL="${REPO_URL:-https://github.com/your-org/k8s-manifests.git}"
NAMESPACE="${NAMESPACE:-default}"
RESOURCE_TYPE="${RESOURCE_TYPE:-deployment}"
RESOURCE_NAME="${RESOURCE_NAME:-my-app}"
MANIFEST_PATH="${MANIFEST_PATH:-$NAMESPACE/$RESOURCE_NAME.yaml}"
BRANCH="${BRANCH:-main}"

WORK_DIR="/tmp/k8s-manifests"
rm -rf "$WORK_DIR"

echo "📥 Cloning $REPO_URL (branch: $BRANCH)..."
git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$WORK_DIR"

echo "📡 Fetching live $RESOURCE_TYPE/$RESOURCE_NAME from $NAMESPACE namespace..."
kubectl get "$RESOURCE_TYPE" "$RESOURCE_NAME" -n "$NAMESPACE" -o yaml > /tmp/live.yaml

echo "📄 Loading desired manifest from $MANIFEST_PATH..."
cp "$WORK_DIR/$MANIFEST_PATH" /tmp/desired.yaml

echo "🔍 Comparing desired and live manifests..."
diff_output=$(diff -u /tmp/desired.yaml /tmp/live.yaml || true)

if [ -n "$diff_output" ]; then
  echo "🚨 Drift detected for $RESOURCE_TYPE $RESOURCE_NAME:"
  echo "-----------------------------------------------"
  echo "$diff_output"
  echo "-----------------------------------------------"
  exit 1
else
  echo "✅ No drift detected for $RESOURCE_TYPE $RESOURCE_NAME."
fi
