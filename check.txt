#!/bin/bash
set -e

echo "ğŸ“¥ Starting drift check..."

RESOURCE_TYPE="${RESOURCE_TYPE:-deployment}"
RESOURCE_NAME="${RESOURCE_NAME:-my-app}"
NAMESPACE="${NAMESPACE:-default}"
DESIRED_MANIFEST="${DESIRED_MANIFEST:-}"

if [[ -z "$DESIRED_MANIFEST" ]]; then
  echo "âŒ Error: DESIRED_MANIFEST is not set"
  exit 1
fi

echo "âœ… Writing desired manifest to /tmp/desired.yaml"
echo "$DESIRED_MANIFEST" > /tmp/desired.yaml

echo "ğŸ“¡ Fetching live manifest from Kubernetes"
kubectl get "$RESOURCE_TYPE" "$RESOURCE_NAME" -n "$NAMESPACE" -o yaml > /tmp/live.yaml

echo "ğŸ” Performing raw diff check..."
diff_output=$(diff -u /tmp/desired.yaml /tmp/live.yaml || true)

if [[ -n "$diff_output" ]]; then
  echo "ğŸš¨ Drift Detected Between Desired and Live State:"
  echo "$diff_output"
  exit 2
else
  echo "âœ… No drift detected."
fi
